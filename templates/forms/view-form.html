{% load widget_tweaks %}
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="https://draggable.github.io/formeo/assets/css/formeo.min.css">

<form action="{{ submit_url }}" method="post" enctype="multipart/form-data" id="view-form-container">


</form>

<div class="mt-4 mb-4">
    <input type="submit" id="submit-wf-form" value="{% if is_update %}Update{% else %}Save{% endif %}" class="btn btn-primary">
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://formbuilder.online/assets/js/form-render.min.js"></script>
<script>
    jQuery(function($) {
        let formElement = $('#view-form-container');
        let frInstance = formElement.formRender({
            dataType: 'json',
            formData: {{ form_config|safe }}
        });

        $('#submit-wf-form').on('click', function (e) {
            formElement.submit()
        })

        formElement.on('submit', handleFormFormSubmission)

        function handleFormFormSubmission (e) {
            e.preventDefault();
            let data = new FormData(this);
            data.set('fb_data', JSON.stringify(frInstance.userData))
            $.ajax({
                url: '{{ submit_url }}',
                data: data,
                method: 'post',
                contentType: false,
                processData: false,
                headers: {"Authorization": "Token " + window.top.WORKFLOW_TOKEN},
                success: function (data) {
                    let event = new CustomEvent('user-submitted-workflow-form', {detail:{status:'success', data: data}})
                    window.parent.document.dispatchEvent(event)
                },
                error: function (resp) {
                    alert('Error occurred saving form')
                }
            })
        }
    });
</script>